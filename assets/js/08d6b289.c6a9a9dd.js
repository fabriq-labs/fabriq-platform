"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[576],{3905:(e,t,a)=>{a.d(t,{Zo:()=>p,kt:()=>h});var r=a(7294);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,r)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,r,n=function(e,t){if(null==e)return{};var a,r,n={},i=Object.keys(e);for(r=0;r<i.length;r++)a=i[r],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)a=i[r],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var l=r.createContext({}),u=function(e){var t=r.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},p=function(e){var t=u(e.components);return r.createElement(l.Provider,{value:t},e.children)},c="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var a=e.components,n=e.mdxType,i=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),c=u(a),d=n,h=c["".concat(l,".").concat(d)]||c[d]||m[d]||i;return a?r.createElement(h,o(o({ref:t},p),{},{components:a})):r.createElement(h,o({ref:t},p))}));function h(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var i=a.length,o=new Array(i);o[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[c]="string"==typeof e?e:n,o[1]=s;for(var u=2;u<i;u++)o[u]=a[u];return r.createElement.apply(null,o)}return r.createElement.apply(null,a)}d.displayName="MDXCreateElement"},4717:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>m,frontMatter:()=>i,metadata:()=>s,toc:()=>u});var r=a(7462),n=(a(7294),a(3905));const i={sidebar_position:4,sidebar_label:"Organizations and user setup"},o="Organizations and user creation",s={unversionedId:"quickstart/org_setup",id:"quickstart/org_setup",title:"Organizations and user creation",description:"Prerequisites",source:"@site/docs/quickstart/org_setup.md",sourceDirName:"quickstart",slug:"/quickstart/org_setup",permalink:"/docs/quickstart/org_setup",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/quickstart/org_setup.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{sidebar_position:4,sidebar_label:"Organizations and user setup"},sidebar:"tutorialSidebar",previous:{title:"Initializing a Database",permalink:"/docs/quickstart/init_database"},next:{title:"Configuring Hasura",permalink:"/docs/quickstart/configure_hasura"}},l={},u=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Steps to Create an Organization",id:"steps-to-create-an-organization",level:2},{value:"Create Groups",id:"create-groups",level:2},{value:"Prerequisites",id:"prerequisites-1",level:3},{value:"Steps to Create Groups",id:"steps-to-create-groups",level:3},{value:"Create users",id:"create-users",level:2},{value:"Steps to Create Users",id:"steps-to-create-users",level:3},{value:"Option 1: Create via the Firebase Console",id:"option-1-create-via-the-firebase-console",level:3},{value:"Option 2: Create by Following the Code Snippet",id:"option-2-create-by-following-the-code-snippet",level:3}],p={toc:u},c="wrapper";function m(e){let{components:t,...i}=e;return(0,n.kt)(c,(0,r.Z)({},p,i,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("h1",{id:"organizations-and-user-creation"},"Organizations and user creation"),(0,n.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,n.kt)("p",null,"Before proceeding with the organization creation, ensure that you have the following prerequisites in place:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Access to the system"),(0,n.kt)("li",{parentName:"ul"},"Database details (host, port, name, username, password)"),(0,n.kt)("li",{parentName:"ul"},"DB tool like DBeaver installed and configured")),(0,n.kt)("h2",{id:"steps-to-create-an-organization"},"Steps to Create an Organization"),(0,n.kt)("p",null,"If you are creating a new user for an existing organization, you can skip this part."),(0,n.kt)("p",null,"Follow these steps to create an organization:"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"Launch the DB tool (e.g., DBeaver) and connect to the PostgreSQL database server using the provided database details.")),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"DB",src:a(3752).Z,width:"1848",height:"1047"})),(0,n.kt)("ol",{start:2},(0,n.kt)("li",{parentName:"ol"},"Once connected, open a new SQL editor or query console."),(0,n.kt)("li",{parentName:"ol"},"Run the following SQL query to create the organization:",(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-sql"},"INSERT INTO public.organizations (updated_at, created_at, \"name\", slug, settings)\nVALUES (CURRENT_DATE, CURRENT_DATE, 'Organization Name', 'organization_slug', '{}');\n"))),(0,n.kt)("li",{parentName:"ol"},"In the DB tool, navigate to the appropriate database and find the organizations table.")),(0,n.kt)("h2",{id:"create-groups"},"Create Groups"),(0,n.kt)("p",null,"Once the organization is created, you can proceed with creating groups associated with the organization."),(0,n.kt)("h3",{id:"prerequisites-1"},"Prerequisites"),(0,n.kt)("p",null,"Before creating groups, ensure that you have the following information available:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Organization ID: The ID of the organization created in the previous step."),(0,n.kt)("li",{parentName:"ul"},"Group Type: The type of the group (e.g., built-in, custom)."),(0,n.kt)("li",{parentName:"ul"},"Group Name: The name of the group."),(0,n.kt)("li",{parentName:"ul"},"Group Permissions: The permissions assigned to the group.")),(0,n.kt)("h3",{id:"steps-to-create-groups"},"Steps to Create Groups"),(0,n.kt)("p",null,"Follow these steps to create groups for the organization:"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Open the DB tool (e.g., DBeaver) and connect to the PostgreSQL database server.")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Select the appropriate database that contains the organization and group tables.")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Open a new SQL editor or query console.")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Run the following SQL query to create a group:"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-sql"},'INSERT INTO public."groups" (org_id, "type", "name", permissions, created_at)\nVALUES(org_id, \'builtin\', \'admin\', \'{"admin","super_admin"}\', current_date);\n')),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-sql"},'INSERT INTO public."groups" (org_id, "type", "name", permissions, created_at)\nVALUES(5, \'builtin\', \'default\', \'{"create_dashboard","create_query","edit_dashboard","edit_query","view_query",\n"view_source","execute_query","list_users","schedule_query",\n"list_dashboards","list_alerts","list_data_sources"}\', \'2021-06-08\');\n')))),(0,n.kt)("p",null,"Replace org_id with the ID of the organization, group_type with the type of the group, group_name with the name of the group, and set the desired permissions for the group. Also, update the current data in the following format ",(0,n.kt)("inlineCode",{parentName:"p"},"YYYY-MM-DD"),"."),(0,n.kt)("h2",{id:"create-users"},"Create users"),(0,n.kt)("p",null,"Once the organization and groups are created, you can proceed with creating users and assigning them to the respective groups."),(0,n.kt)("h3",{id:"steps-to-create-users"},"Steps to Create Users"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Open the DB tool (e.g., DBeaver) and connect to the PostgreSQL database server.")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Select the appropriate database that contains the organization, group, and user tables.")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Open a new SQL editor or query console.")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Generate an API key for the user using the following Python code snippet:"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-python"},'def generate_token(length):\n    chars = "abcdefghijklmnopqrstuvwxyz" "ABCDEFGHIJKLMNOPQRSTUVWXYZ" "0123456789"\n    rand = random.SystemRandom()\n    return "".join(rand.choice(chars) for x in range(length))\n'))),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Run the following SQL query to create a user:\nBefore running the following SQL query to create a user, ensure you have the correct values for the placeholders:"),(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"org_id"),": The ID of the organization to which the user will be associated."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"name"),": The name of the new user you want to create."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"group_ids"),": The group IDs to which the user belongs. Update this with the relevant group IDs. For example, if the user belongs to groups 1, 3, and 5, the value should be '{1,3,5}'."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"token_from_generate_token_function"),": Replace this with the actual token obtained from the ",(0,n.kt)("inlineCode",{parentName:"li"},"generate_token")," function, which will provide the necessary API access for the user."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"current_date"),": YYYY-MM-DD")),(0,n.kt)("p",{parentName:"li"},"After ensuring you have the correct values in place, you can run the following SQL query to create the new user:"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-sql"},"INSERT INTO public.users (updated_at, created_at, org_id, \"name\", email, profile_image_url, password_hash, \"groups\", api_key, disabled_at, details, home_db_slug)\nVALUES(current_date, current_date, org_id, 'name', 'test@test.com', NULL, NULL, '{8, 9}', 'token which you get from generate_token function', NULL, '{\"is_invitation_pending\": false}', NULL);\n"))),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Creating the User in Firebase"),(0,n.kt)("p",{parentName:"li"},"To create the user with the same email in Firebase, you have two options:"))),(0,n.kt)("h3",{id:"option-1-create-via-the-firebase-console"},"Option 1: Create via the Firebase Console"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"Log in to your Firebase project using the ",(0,n.kt)("a",{parentName:"li",href:"https://console.firebase.google.com/"},"Firebase console"),"."),(0,n.kt)("li",{parentName:"ol"},'Navigate to the "Authentication" section in the left sidebar.'),(0,n.kt)("li",{parentName:"ol"},'Click on the "Add User" button to create a new user.'),(0,n.kt)("li",{parentName:"ol"},"Enter the user's email and set a password (e.g., 'test@123') for the user.")),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"Authentication",src:a(461).Z,width:"1750",height:"513"})),(0,n.kt)("h3",{id:"option-2-create-by-following-the-code-snippet"},"Option 2: Create by Following the Code Snippet"),(0,n.kt)("p",null,"Alternatively, you can create the user programmatically using the provided code snippet below. This snippet is written in Python and utilizes the Firebase Admin SDK to interact with Firebase Authentication. Make sure you have the Firebase Admin SDK set up correctly before using this code."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-python"},"def create_user_firebase(email, org_slug, org_id, user_id, org_name, name):\n    custom_claims = {}\n    custom_claims[\"https://fabriq/jwt/claims\"] = [{'fabriq_org_slug': org_slug, 'fabriq_org_id': org_id,\n                                                            \"fabriq_user_id\": user_id, \"fabriq_org_name\": org_name}]\n    user = auth.create_user(\n        email=email,\n        email_verified=True,\n        password='test@123',  # Replace this with the desired password for the user\n        display_name=name,\n        disabled=False)\n    print('Successfully created a new user in Firebase: {0}'.format(user.uid))\n\n    auth.set_custom_user_claims(user.uid, custom_claims)\n")),(0,n.kt)("p",null,"Remember to call the ",(0,n.kt)("inlineCode",{parentName:"p"},"create_user_firebase")," function with the necessary parameters (email, org_slug, org_id, user_id, org_name, name) to create the user in Firebase with the custom claims."),(0,n.kt)("p",null,"Before running the code snippet, ensure you have the ",(0,n.kt)("inlineCode",{parentName:"p"},"firebase-key-admin.json")," file in the same directory as the script. This file is required to initialize the Firebase Admin SDK with the necessary credentials."),(0,n.kt)("p",null,(0,n.kt)("strong",{parentName:"p"},(0,n.kt)("em",{parentName:"strong"},"firebase-admin-key.json"))),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},'{\n    "type": "xxx",\n    "project_id": "xxx",\n    "private_key_id": "xxx",\n    "private_key": "-----BEGIN PRIVATE KEY-----\\xxx\\n-----END PRIVATE KEY-----\\n",\n    "client_email": "xxx",\n    "client_id": "xxx",\n    "auth_uri": "https://accounts.google.com/o/oauth2/auth",\n    "token_uri": "https://oauth2.googleapis.com/token",\n    "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",\n    "client_x509_cert_url": "xxx"\n}\n')),(0,n.kt)("h1",{id:"updating-custom-claims-for-an-existing-user"},"Updating Custom Claims for an Existing User"),(0,n.kt)("p",null,"To update custom claims for an existing user, you can use the following Python code snippet. Replace the variables with actual values obtained during the user creation process."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-python"},'import firebase_admin\nfrom firebase_admin import auth\n\n# Initialize the Firebase Admin SDK with the necessary credentials (firebase-key-admin.json).\n# firebase_admin.initialize_app()\n\nuser = auth.get_user_by_email("user_email@example.com")\ncustom_claims = user.custom_claims\n\nobj = {\n    "fabriq_org_slug": "organization_slug",\n    "fabriq_org_id": "organization_id",\n    "fabriq_user_id": "user_id",\n    "fabriq_org_name": "organization_name"\n}\n\nif custom_claims is not None:\n    data = custom_claims.get("https://auth.fabriq.com/jwt/claims").get("fabriq_orgs")\n    new_list = []\n    fabriq_org_slug = set()\n    isAvailable = False\n\n    for objData in data:\n        print("obj", objData[\'fabriq_org_slug\'])\n        if objData[\'fabriq_org_slug\'] not in fabriq_org_slug:\n            if objData[\'fabriq_org_slug\'] == obj.get("fabriq_org_slug"):\n                isAvailable = True\n            new_list.append(objData)\n            fabriq_org_slug.add(objData[\'fabriq_org_slug\'])\n\ncustom_claims_filter = {\n    "https://auth.fabriq.com/jwt/claims": {\n        "fabriq_orgs": new_list\n    }\n}\n\ncustom_claims = custom_claims_filter\nif custom_claims is None:\n    fabriq_orgs = [obj]\n    custom_claims = {\n        "https://auth.fabriq.com/jwt/claims": {"fabriq_orgs": fabriq_orgs}}\nelse:\n    if not isAvailable:\n        claim_obj = custom_claims["https://auth.fabriq.com/jwt/claims"]\n        orgs_list = claim_obj["fabriq_orgs"]\n        orgs_list.append(obj)\n\n        custom_claims = {\n            "https://auth.fabriq.com/jwt/claims": {"fabriq_orgs": orgs_list}}\n\nauth.set_custom_user_claims(user.uid, custom_claims)\nresult = auth.get_user_by_email(\'user_email@example.com\')\ncustom_claims = result.custom_claims\n')),(0,n.kt)("p",null,"Replace these variables with actual values obtained during the user creation process."),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"user_email@example.com"),": The email address of the user you want to update the claims for."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"organization_slug"),": The slug of the organization to which the user belongs."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"organization_id"),": The ID of the organization to which the user belongs."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"user_id"),": The ID of the user you want to update the claims for."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"organization_name"),": The name of the organization to which the user belongs.")),(0,n.kt)("p",null,"Ensure that you have the ",(0,n.kt)("inlineCode",{parentName:"p"},"firebase-key-admin.json")," file in the same directory as this script to initialize the Firebase Admin SDK with the necessary credentials."))}m.isMDXComponent=!0},3752:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/db-792894ec8b66cedebf4f8f1942531f48.png"},461:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/user_auth-898d6e3809a8e21d69c5520963c24e51.png"}}]);